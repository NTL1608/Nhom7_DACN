<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/header :: header}"></head>
<!-- Toast CSS -->
<link th:href="@{/css/toast.css}" rel="stylesheet">
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: navbar}"></div>

<!-- Breadcrumb -->
<section class="py-3 bg-light">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/books}">Kho sách</a></li>
                <li class="breadcrumb-item" th:if="${book.category != null}">
                    <a th:href="@{/books(categoryId=${book.category.id})}"
                       th:text="${book.category.name}">Danh mục</a>
                </li>
                <li class="breadcrumb-item active" th:text="${book.title}">Tên sách</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Book Detail -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <!-- Left: Image Gallery -->
            <div class="col-lg-5">
                <div class="book-images sticky-top" style="top: 20px;">
                    <!-- Main Image -->
                    <div class="main-image-container mb-3">
                        <img id="mainImage"
                             th:src="${book.imageUrls != null && !book.imageUrls.isEmpty() ? book.imageUrls[0] : 'https://images.unsplash.com/photo-1543002588-bfa74002ed7e?w=600&h=800&fit=crop'}"
                             th:alt="${book.title}"
                             class="img-fluid rounded shadow-lg">

                        <!-- Stock Badge -->
                        <div class="position-absolute top-0 end-0 m-3">
                            <span th:if="${book.stockQuantity > 0}" class="badge badge-success-custom">
                                <i class="bi bi-check-circle me-1"></i>Còn hàng
                            </span>
                            <span th:if="${book.stockQuantity == 0}" class="badge badge-danger-custom">
                                <i class="bi bi-x-circle me-1"></i>Hết hàng
                            </span>
                        </div>
                    </div>

                    <!-- Thumbnail Gallery -->
                    <div class="thumbnail-gallery" th:if="${book.imageUrls != null && book.imageUrls.size() > 1}">
                        <div class="row g-2">
                            <div class="col-3" th:each="imageUrl, iterStat : ${book.imageUrls}">
                                <img th:src="${imageUrl}"
                                     th:alt="${book.title + ' - Ảnh ' + (iterStat.index + 1)}"
                                     class="thumbnail-image img-fluid rounded cursor-pointer"
                                     th:classappend="${iterStat.index == 0 ? 'active' : ''}"
                                     onclick="changeMainImage(this.src)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Book Info -->
            <div class="col-lg-7">
                <div class="book-info">
                    <!-- Category Badge -->
                    <div class="mb-2" th:if="${book.category != null}">
                        <a th:href="@{/books(categoryId=${book.category.id})}"
                           class="badge bg-light text-primary text-decoration-none">
                            <i class="bi bi-tag me-1"></i>
                            <span th:text="${book.category.name}">Danh mục</span>
                        </a>
                    </div>

                    <!-- Title -->
                    <h1 class="book-title mb-3" th:text="${book.title}">Tên sách</h1>

                    <!-- Author & Publisher -->
                    <div class="book-meta mb-3">
                        <p class="mb-2" th:if="${book.author != null}">
                            <i class="bi bi-person-fill text-primary me-2"></i>
                            <strong>Tác giả:</strong>
                            <span th:text="${book.author}">Tác giả</span>
                        </p>
                        <p class="mb-2" th:if="${book.publisher != null}">
                            <i class="bi bi-building text-primary me-2"></i>
                            <strong>Nhà xuất bản:</strong>
                            <span th:text="${book.publisher}">NXB</span>
                        </p>
                        <p class="mb-2" th:if="${book.publishedDate != null}">
                            <i class="bi bi-calendar-event text-primary me-2"></i>
                            <strong>Năm xuất bản:</strong>
                            <span th:text="${#temporals.format(book.publishedDate, 'dd/MM/yyyy')}">2024</span>
                        </p>
                    </div>

                    <!-- Rating -->
                    <div class="rating-section mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="stars">
                                <i class="bi bi-star-fill text-warning"></i>
                                <i class="bi bi-star-fill text-warning"></i>
                                <i class="bi bi-star-fill text-warning"></i>
                                <i class="bi bi-star-fill text-warning"></i>
                                <i class="bi bi-star text-warning"></i>
                            </div>
                            <span class="text-muted small">(4.0 / 5.0)</span>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="price-section mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <h2 class="price-main mb-0 text-primary fw-bold"
                                th:text="${book.originalPrice != null ? #numbers.formatDecimal(book.originalPrice, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ'}">
                                120,000đ
                            </h2>
                        </div>
                    </div>

                    <!-- Stock Info -->
                    <div class="stock-info mb-4">
                        <div class="alert alert-success-custom" th:if="${book.stockQuantity > 0}">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Còn <span th:text="${book.stockQuantity}">10</span> sản phẩm</strong>
                        </div>
                        <div class="alert alert-danger-custom" th:if="${book.stockQuantity == 0}">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Tạm hết hàng</strong>
                        </div>
                    </div>

                    <!-- Quantity Selector & Add to Cart -->
                    <div class="purchase-section mb-4" th:if="${book.stockQuantity > 0}">
                        <form th:action="@{/cart/add}" method="post">
                            <input type="hidden" name="bookId" th:value="${book.id}">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Số lượng:</label>
                                    <div class="quantity-selector">
                                        <button type="button" class="btn-qty minus" onclick="decreaseQty()">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number"
                                               id="quantity"
                                               name="quantity"
                                               value="1"
                                               min="1"
                                               th:max="${book.stockQuantity}"
                                               class="qty-input">
                                        <button type="button" class="btn-qty plus" onclick="increaseQty()">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold opacity-0">Action</label>
                                    <div class="d-grid gap-2">
                                        <form class="cart-form">
                                            <input type="hidden" name="bookId" th:value="${book.id}">
                                            <div class="row g-3">
                                                <!-- ... quantity selector ... -->
                                                <div class="col-md-8">
                                                    <label class="form-label fw-bold opacity-0">Action</label>
                                                    <div class="d-grid gap-2">
                                                        <button type="submit" class="btn btn-primary btn-lg">
                                                            <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ hàng
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions mb-4">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="addToWishlist()">
                                    <i class="bi bi-heart me-2"></i>Yêu thích
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary w-100" onclick="shareBook()">
                                    <i class="bi bi-share me-2"></i>Chia sẻ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description & Info Tabs -->
        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs custom-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#description">
                            <i class="bi bi-file-text me-2"></i>Mô tả sản phẩm
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specs">
                            <i class="bi bi-info-circle me-2"></i>Thông tin chi tiết
                        </button>
                    </li>
                </ul>

                <div class="tab-content custom-tab-content">
                    <!-- Description Tab -->
                    <div class="tab-pane fade show active" id="description">
                        <div class="description-content" th:if="${book.description != null && !book.description.isEmpty()}">
                            <p th:text="${book.description}">Mô tả sách...</p>
                        </div>
                        <div class="description-content" th:if="${book.description == null || book.description.isEmpty()}">
                            <p class="text-muted">Chưa có mô tả chi tiết cho sản phẩm này.</p>
                        </div>
                    </div>

                    <!-- Specifications Tab -->
                    <div class="tab-pane fade" id="specs">
                        <div class="specs-table">
                            <table class="table table-bordered">
                                <tbody>
                                <tr>
                                    <th width="30%">Tên sách</th>
                                    <td th:text="${book.title}">-</td>
                                </tr>
                                <tr th:if="${book.author != null}">
                                    <th>Tác giả</th>
                                    <td th:text="${book.author}">-</td>
                                </tr>
                                <tr th:if="${book.publisher != null}">
                                    <th>Nhà xuất bản</th>
                                    <td th:text="${book.publisher}">-</td>
                                </tr>
                                <tr th:if="${book.publishedDate != null}">
                                    <th>Năm xuất bản</th>
                                    <td th:text="${#temporals.format(book.publishedDate, 'dd/MM/yyyy')}">-</td>
                                </tr>
                                <tr th:if="${book.category != null}">
                                    <th>Danh mục</th>
                                    <td th:text="${book.category.name}">-</td>
                                </tr>
                                <tr>
                                    <th>Tình trạng</th>
                                    <td>
                                        <span class="badge bg-success" th:if="${book.stockQuantity > 0}">Còn hàng</span>
                                        <span class="badge bg-danger" th:if="${book.stockQuantity == 0}">Hết hàng</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Books -->
        <div class="row mt-5" th:if="${relatedBooks != null && !#lists.isEmpty(relatedBooks)}">
            <div class="col-12">
                <div class="section-header mb-4">
                    <h3 class="fw-bold">Sách liên quan</h3>
                    <a th:href="@{/books(categoryId=${book.category.id})}" class="btn btn-outline-primary">
                        Xem tất cả <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>

                <div class="row g-4">
                    <div class="col-lg-3 col-md-4 col-sm-6" th:each="relatedBook : ${relatedBooks}">
                        <div class="product-card">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="product-image position-relative">
                                    <a th:href="@{/books/{id}(id=${relatedBook.id})}">
                                        <img th:src="${relatedBook.imageUrls != null && !relatedBook.imageUrls.isEmpty() ? relatedBook.imageUrls[0] : 'https://images.unsplash.com/photo-1543002588-bfa74002ed7e?w=400&h=600&fit=crop'}"
                                             th:alt="${relatedBook.title}"
                                             class="card-img-top">
                                    </a>

                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span th:if="${relatedBook.stockQuantity > 0}" class="badge bg-success">
                                            Còn hàng
                                        </span>
                                        <span th:if="${relatedBook.stockQuantity == 0}" class="badge bg-danger">
                                            Hết hàng
                                        </span>
                                    </div>

                                    <div class="product-actions">
                                        <a th:href="@{/books/{id}(id=${relatedBook.id})}"
                                           class="btn btn-sm btn-light">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-light"
                                                th:if="${relatedBook.stockQuantity > 0}">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <h6 class="card-title text-truncate mb-2"
                                        th:text="${relatedBook.title}">Tên sách</h6>
                                    <p class="text-muted small mb-2" th:text="${relatedBook.author}">Tác giả</p>
                                    <span class="h6 mb-0 text-primary"
                                          th:text="${relatedBook.originalPrice != null ? #numbers.formatDecimal(relatedBook.originalPrice, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ'}">
                                        120,000đ
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<div th:replace="~{fragments/footer :: footer-bottom}"></div>

<!-- Scripts -->
<th:block th:replace="~{fragments/footer :: scripts}"></th:block>
<!-- Cart JavaScript -->
<script th:src="@{/js/cart.js}"></script>

<style>
    :root {
        --primary-green: #40916c;
        --light-green: #74c69d;
        --pale-green: #b7e4c7;
        --extra-light: #d8f3dc;
        --dark-text: #2d6a4f;
        --cream: #f1faee;
    }

    .bg-primary { background-color: var(--primary-green) !important; }
    .text-primary { color: var(--primary-green) !important; }
    .btn-primary {
        background-color: var(--primary-green);
        border-color: var(--primary-green);
    }
    .btn-primary:hover {
        background-color: var(--light-green);
        border-color: var(--light-green);
    }
    .btn-outline-primary {
        color: var(--primary-green);
        border-color: var(--primary-green);
    }
    .btn-outline-primary:hover {
        background-color: var(--primary-green);
        color: white;
    }

    .breadcrumb-item a {
        color: var(--primary-green);
        text-decoration: none;
    }

    /* Book Images */
    .main-image-container {
        position: relative;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .main-image-container img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .main-image-container:hover img {
        transform: scale(1.05);
    }

    .thumbnail-image {
        border: 2px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
        height: 80px;
        object-fit: cover;
    }

    .thumbnail-image:hover,
    .thumbnail-image.active {
        border-color: var(--primary-green);
        transform: scale(1.05);
    }

    /* Badges */
    .badge-success-custom {
        background: linear-gradient(135deg, #40916c, #74c69d);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 50px;
        box-shadow: 0 4px 10px rgba(64, 145, 108, 0.3);
    }

    .badge-danger-custom {
        background: linear-gradient(135deg, #dc3545, #ff6b6b);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 50px;
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
    }

    /* Book Info */
    .book-title {
        color: var(--dark-text);
        font-size: 2rem;
        line-height: 1.3;
    }

    .book-meta p {
        font-size: 0.95rem;
        color: #6c757d;
    }

    .price-main {
        font-size: 2.5rem;
    }

    /* Alerts */
    .alert-success-custom {
        background-color: var(--extra-light);
        border-color: var(--pale-green);
        color: var(--dark-text);
        border-left: 4px solid var(--primary-green);
    }

    .alert-danger-custom {
        background-color: #ffe5e5;
        border-color: #ffcccc;
        color: #dc3545;
        border-left: 4px solid #dc3545;
    }

    /* Quantity Selector */
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 0;
        height: 46px;
    }

    .btn-qty {
        width: 46px;
        height: 46px;
        border: 1px solid #dee2e6;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .btn-qty.minus {
        border-radius: 8px 0 0 8px;
    }

    .btn-qty.plus {
        border-radius: 0 8px 8px 0;
    }

    .btn-qty:hover {
        background: var(--primary-green);
        color: white;
        border-color: var(--primary-green);
    }

    .qty-input {
        width: 80px;
        height: 46px;
        text-align: center;
        border: 1px solid #dee2e6;
        border-left: none;
        border-right: none;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .qty-input:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    /* Tabs */
    .custom-tabs {
        border-bottom: 2px solid var(--pale-green);
    }

    .custom-tabs .nav-link {
        color: var(--dark-text);
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .custom-tabs .nav-link:hover {
        color: var(--primary-green);
        border-bottom-color: var(--pale-green);
    }

    .custom-tabs .nav-link.active {
        color: var(--primary-green);
        border-bottom-color: var(--primary-green);
        background: transparent;
    }

    .custom-tab-content {
        padding: 2rem;
        background: white;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .description-content {
        line-height: 1.8;
        font-size: 1rem;
    }

    .specs-table table {
        margin-bottom: 0;
    }

    .specs-table th {
        background: var(--extra-light);
        color: var(--dark-text);
        font-weight: 600;
    }

    /* Section Header */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid var(--pale-green);
        padding-bottom: 1rem;
    }

    /* Product Card (for related books) */
    .product-card {
        transition: transform 0.3s ease;
    }

    .product-card:hover {
        transform: translateY(-5px);
    }

    .product-image {
        height: 300px;
        overflow: hidden;
        position: relative;
        background: #f8f9fa;
    }

    .product-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-image img {
        transform: scale(1.05);
    }

    .product-actions {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .product-card:hover .product-actions {
        opacity: 1;
    }

    .product-actions .btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        background: white;
    }

    .product-actions .btn:hover {
        background: var(--primary-green) !important;
        color: white !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .book-title {
            font-size: 1.5rem;
        }

        .price-main {
            font-size: 2rem;
        }

        .quantity-selector {
            justify-content: center;
        }

        .main-image-container img {
            max-height: 400px;
        }
    }

    /* Cursor Pointer */
    .cursor-pointer {
        cursor: pointer;
    }
</style>

<script>
    // Change main image when clicking thumbnail
    function changeMainImage(src) {
        const mainImage = document.getElementById('mainImage');
        mainImage.src = src;

        // Update active thumbnail
        document.querySelectorAll('.thumbnail-image').forEach(thumb => {
            thumb.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // Quantity controls
    function increaseQty() {
        const input = document.getElementById('quantity');
        const max = parseInt(input.max);
        const current = parseInt(input.value);

        if (current < max) {
            input.value = current + 1;
        }
    }

    function decreaseQty() {
        const input = document.getElementById('quantity');
        const current = parseInt(input.value);

        if (current > 1) {
            input.value = current - 1;
        }
    }

    // Add to cart
    function addToCart(button) {
        const bookId = button.getAttribute('data-book-id');
        const quantity = document.getElementById('quantity').value;

        // TODO: Implement cart functionality
        console.log('Adding to cart:', {bookId, quantity});

        // Visual feedback
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check2 me-2"></i>Đã thêm!';
        button.classList.add('btn-success');
        button.classList.remove('btn-primary');

        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-primary');
        }, 2000);

        if (typeof showToast === 'function') {
            showToast('Đã thêm sách vào giỏ hàng!', 'success');
        }
    }

    // Add to wishlist
    function addToWishlist() {
        // TODO: Implement wishlist functionality
        if (typeof showToast === 'function') {
            showToast('Đã thêm vào danh sách yêu thích!', 'success');
        }
    }

    // Share book
    function shareBook() {
        if (navigator.share) {
            navigator.share({
                title: document.querySelector('.book-title').textContent,
                url: window.location.href
            });
        } else {
            // Fallback: Copy link to clipboard
            navigator.clipboard.writeText(window.location.href);
            if (typeof showToast === 'function') {
                showToast('Đã sao chép link!', 'success');
            }
        }
    }

    // Prevent manual input exceeding stock
    document.getElementById('quantity')?.addEventListener('input', function() {
        const max = parseInt(this.max);
        const value = parseInt(this.value);

        if (value > max) {
            this.value = max;
            if (typeof showToast === 'function') {
                showToast('Số lượng tối đa: ' + max, 'warning');
            }
        } else if (value < 1) {
            this.value = 1;
        }
    });
</script>

</body>
</html>