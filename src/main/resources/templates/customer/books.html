<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/header :: header}"></head>
<!-- Toast CSS -->
<link th:href="@{/css/toast.css}" rel="stylesheet">
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: navbar}"></div>

<!-- Breadcrumb -->
<section class="py-3 bg-light">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Kho sách</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Books List -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Sidebar Filter -->
            <div class="col-lg-3 mb-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Bộ lọc</h5>
                    </div>
                    <div class="card-body">
                        <!-- Category Filter -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Danh mục</h6>

                            <!-- Container với scroll -->
                            <div class="category-scroll-container">
                                <div class="list-group">
                                    <a th:href="@{/books(page=0)}"
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                       th:classappend="${selectedCategoryId == null ? 'active' : ''}"
                                       data-category-id="">
                                        <span><i class="bi bi-grid-3x3-gap me-2"></i>Tất cả</span>
                                        <span class="badge bg-secondary rounded-pill" th:text="${totalItems}">0</span>
                                    </a>

                                    <a th:each="category : ${categories}"
                                       th:href="@{/books(categoryId=${category.id}, page=0)}"
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                       th:classappend="${category.id == selectedCategoryId ? 'active' : ''}"
                                       th:data-category-id="${category.id}">
                                        <span th:text="${category.name}">Danh mục</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Reset Filter -->
                        <a th:href="@{/books}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>Đặt lại bộ lọc
                        </a>
                    </div>
                </div>
            </div>

            <!-- Books Grid -->
            <div class="col-lg-9">
                <!-- Toolbar -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                    <div>
                        <h4 class="mb-1">
                            <span th:if="${selectedCategoryId == null}">Tất cả sách</span>
                            <span th:if="${selectedCategoryId != null}" th:each="cat : ${categories}">
                                <span th:if="${cat.id == selectedCategoryId}" th:text="${cat.name}">Danh mục</span>
                            </span>
                        </h4>
                        <p class="text-muted mb-0" id="bookInfoText">
                            Hiển thị
                            <strong th:text="${#lists.size(books)}">0</strong>
                            trong tổng số
                            <strong th:text="${totalItems}">0</strong> cuốn sách
                        </p>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <!-- Sort Dropdown -->
                        <select class="form-select" style="width: auto;" id="sortSelect">
                            <option value="" disabled selected>Sắp xếp theo</option>
                            <option th:value="@{/books(categoryId=${selectedCategoryId}, page=${currentPage}, sort='id', order='desc')}"
                                    th:selected="${currentSort == 'id' && currentOrder == 'desc'}">
                                Mới nhất
                            </option>
                            <option th:value="@{/books(categoryId=${selectedCategoryId}, page=${currentPage}, sort='originalPrice', order='asc')}"
                                    th:selected="${currentSort == 'originalPrice' && currentOrder == 'asc'}">
                                Giá tăng dần
                            </option>
                            <option th:value="@{/books(categoryId=${selectedCategoryId}, page=${currentPage}, sort='originalPrice', order='desc')}"
                                    th:selected="${currentSort == 'originalPrice' && currentOrder == 'desc'}">
                                Giá giảm dần
                            </option>
                            <option th:value="@{/books(categoryId=${selectedCategoryId}, page=${currentPage}, sort='title', order='asc')}"
                                    th:selected="${currentSort == 'title' && currentOrder == 'asc'}">
                                Tên A-Z
                            </option>
                            <option th:value="@{/books(categoryId=${selectedCategoryId}, page=${currentPage}, sort='title', order='desc')}"
                                    th:selected="${currentSort == 'title' && currentOrder == 'desc'}">
                                Tên Z-A
                            </option>
                        </select>

                        <!-- View Toggle -->
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary active" title="Xem dạng lưới">
                                <i class="bi bi-grid-3x3-gap-fill"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" title="Xem dạng danh sách">
                                <i class="bi bi-list-ul"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${#lists.isEmpty(books)}" class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3">Không tìm thấy sách nào</h4>
                    <p class="text-muted">Vui lòng thử lại với bộ lọc khác</p>
                    <a th:href="@{/books}" class="btn btn-primary">Xem tất cả sách</a>
                </div>

                <!-- Books Grid -->
                <div class="row g-4" id="booksContainer" th:if="${!#lists.isEmpty(books)}">
                    <div class="col-lg-4 col-md-6" th:each="book : ${books}">
                        <div class="product-card">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="product-image position-relative">
                                    <a th:href="@{/books/{id}(id=${book.id})}">
                                        <img th:src="${book.imageUrls != null && !book.imageUrls.isEmpty() ? book.imageUrls[0] : 'https://images.unsplash.com/photo-1543002588-bfa74002ed7e?w=400&h=600&fit=crop'}"
                                             th:alt="${book.title}"
                                             class="card-img-top">
                                    </a>

                                    <!-- Badge -->
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span th:if="${book.stockQuantity > 0}" class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Còn hàng
                                        </span>
                                        <span th:if="${book.stockQuantity == 0}" class="badge bg-danger">
                                            <i class="bi bi-x-circle me-1"></i>Hết hàng
                                        </span>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="product-actions">
                                        <a th:href="@{/books/{id}(id=${book.id})}"
                                           class="btn btn-sm btn-light"
                                           title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <form class="cart-form" style="display: inline;">
                                            <input type="hidden" name="bookId" th:value="${book.id}">
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit"
                                                    class="btn btn-sm btn-light"
                                                    th:if="${book.stockQuantity > 0}"
                                                    title="Thêm vào giỏ">
                                                <i class="bi bi-cart-plus"></i>
                                            </button>
                                        </form>
                                        <button class="btn btn-sm btn-light wishlist-btn"
                                                th:data-book-id="${book.id}"
                                                title="Yêu thích">
                                            <i class="bi bi-heart"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <a th:href="@{/books/{id}(id=${book.id})}" class="text-decoration-none">
                                        <h6 class="card-title text-truncate mb-2"
                                            th:text="${book.title}"
                                            th:title="${book.title}">
                                            Tên sách
                                        </h6>
                                    </a>
                                    <p class="text-muted small mb-2">
                                        <i class="bi bi-person me-1"></i>
                                        <span th:text="${book.author}">Tác giả</span>
                                    </p>

                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="h6 mb-0 text-primary fw-bold"
                                              th:text="${book.originalPrice != null ? #numbers.formatDecimal(book.originalPrice, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ'}">
                                            120,000đ
                                        </span>
                                        <div class="rating">
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star text-warning"></i>
                                        </div>
                                    </div>

                                    <!-- Category Badge -->
                                    <div th:if="${book.category != null}">
                                        <span class="badge bg-light text-dark">
                                            <i class="bi bi-tag me-1"></i>
                                            <span th:text="${book.category.name}">Danh mục</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination Container -->
                <div id="paginationContainer">
                    <nav th:if="${totalPages > 1}" class="mt-5" aria-label="Phân trang">
                        <!-- Thông tin trang -->
                        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                            <p class="text-muted mb-0 small">
                                Trang <strong class="text-primary" th:text="${currentPage + 1}">1</strong> /
                                <strong th:text="${totalPages}">10</strong>
                            </p>
                            <p class="text-muted mb-0 small">
                                Tổng <strong class="text-primary" th:text="${totalItems}">34</strong> cuốn sách
                            </p>
                        </div>

                        <!-- Pagination -->
                        <ul class="pagination pagination-modern justify-content-center mb-3">
                            <!-- First Page -->
                            <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                <a class="page-link"
                                   th:href="@{/books(categoryId=${selectedCategoryId}, page=0, sort=${currentSort}, order=${currentOrder})}"
                                   title="Trang đầu">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>

                            <!-- Previous -->
                            <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                <a class="page-link"
                                   th:href="@{/books(categoryId=${selectedCategoryId}, page=${currentPage - 1}, sort=${currentSort}, order=${currentOrder})}"
                                   title="Trước">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>

                            <!-- Page Numbers - Smart Display -->
                            <th:block th:with="startPage=${currentPage > 2 ? currentPage - 2 : 0},
                               endPage=${currentPage + 2 < totalPages - 1 ? currentPage + 2 : totalPages - 1}">

                                <!-- First page if not in range -->
                                <li class="page-item" th:if="${startPage > 0}">
                                    <a class="page-link"
                                       th:href="@{/books(categoryId=${selectedCategoryId}, page=0, sort=${currentSort}, order=${currentOrder})}">
                                        1
                                    </a>
                                </li>

                                <!-- Dots if there's a gap -->
                                <li class="page-item disabled" th:if="${startPage > 1}">
                                    <span class="page-link">...</span>
                                </li>

                                <!-- Page numbers in range -->
                                <li th:each="i : ${#numbers.sequence(startPage, endPage)}"
                                    class="page-item"
                                    th:classappend="${i == currentPage ? 'active' : ''}">
                                    <a class="page-link"
                                       th:href="@{/books(categoryId=${selectedCategoryId}, page=${i}, sort=${currentSort}, order=${currentOrder})}"
                                       th:text="${i + 1}">1</a>
                                </li>

                                <!-- Dots if there's a gap -->
                                <li class="page-item disabled" th:if="${endPage < totalPages - 2}">
                                    <span class="page-link">...</span>
                                </li>

                                <!-- Last page if not in range -->
                                <li class="page-item" th:if="${endPage < totalPages - 1}">
                                    <a class="page-link"
                                       th:href="@{/books(categoryId=${selectedCategoryId}, page=${totalPages - 1}, sort=${currentSort}, order=${currentOrder})}"
                                       th:text="${totalPages}">10</a>
                                </li>
                            </th:block>

                            <!-- Next -->
                            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages ? 'disabled' : ''}">
                                <a class="page-link"
                                   th:href="@{/books(categoryId=${selectedCategoryId}, page=${currentPage + 1}, sort=${currentSort}, order=${currentOrder})}"
                                   title="Sau">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>

                            <!-- Last Page -->
                            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages ? 'disabled' : ''}">
                                <a class="page-link"
                                   th:href="@{/books(categoryId=${selectedCategoryId}, page=${totalPages - 1}, sort=${currentSort}, order=${currentOrder})}"
                                   title="Trang cuối">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        </ul>

                        <!-- Jump to page (Tùy chọn - có thể bỏ nếu không cần) -->
                        <div class="d-flex justify-content-center">
                            <div class="input-group" style="max-width: 220px;">
                <span class="input-group-text bg-white border-end-0 small">
                    <i class="bi bi-arrow-right-circle me-2"></i>Đến trang
                </span>
                                <input type="number"
                                       class="form-control form-control-sm border-start-0"
                                       id="jumpToPage"
                                       min="1"
                                       th:max="${totalPages}"
                                       th:placeholder="'1-' + ${totalPages}"
                                       style="max-width: 60px;">
                                <button class="btn btn-primary btn-sm" type="button" onclick="jumpToPage()">
                                    <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>



<style>
    :root {
        --primary-green: #40916c;
        --light-green: #74c69d;
        --pale-green: #b7e4c7;
        --extra-light: #d8f3dc;
        --dark-text: #2d6a4f;
        --cream: #f1faee;
    }

    .bg-primary {
        background-color: var(--primary-green) !important;
    }

    .text-primary {
        color: var(--primary-green) !important;
    }

    .btn-primary {
        background-color: var(--primary-green);
        border-color: var(--primary-green);
    }

    .btn-primary:hover {
        background-color: var(--light-green);
        border-color: var(--light-green);
    }

    .btn-outline-primary {
        color: var(--primary-green);
        border-color: var(--primary-green);
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-green);
        color: white;
    }

    .breadcrumb-item a {
        color: var(--primary-green);
        text-decoration: none;
    }

    .list-group-item.active {
        background-color: var(--primary-green);
        border-color: var(--primary-green);
    }

    .product-card {
        transition: transform 0.3s ease;
    }

    .product-card:hover {
        transform: translateY(-5px);
    }

    .product-image {
        height: 350px;
        overflow: hidden;
        position: relative;
        background: #f8f9fa;
    }

    .product-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-image img {
        transform: scale(1.05);
    }

    .product-actions {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
    }

    .product-card:hover .product-actions {
        opacity: 1;
    }

    .product-actions .btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        background: white;
    }

    .product-actions .btn:hover {
        background: var(--primary-green) !important;
        color: white !important;
        transform: scale(1.1);
    }

    /* Modern Pagination Style */
    .pagination-modern {
        gap: 4px;
        flex-wrap: wrap;
    }

    .pagination-modern .page-link {
        border: 1px solid #dee2e6;
        background: white;
        color: var(--dark-text);
        font-weight: 500;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.3s ease;
        padding: 0.5rem;
    }

    .pagination-modern .page-link:hover:not(.disabled) {
        background: var(--extra-light);
        color: var(--primary-green);
        border-color: var(--primary-green);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(64, 145, 108, 0.15);
    }

    .pagination-modern .page-item.active .page-link {
        background: var(--primary-green);
        color: white;
        border-color: var(--primary-green);
        box-shadow: 0 4px 12px rgba(64, 145, 108, 0.25);
    }

    .pagination-modern .page-item.disabled .page-link {
        opacity: 0.4;
        pointer-events: none;
        background: #f8f9fa;
    }

    /* Jump to page input */
    #jumpToPage {
        text-align: center;
    }

    #jumpToPage:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 0.2rem rgba(64, 145, 108, 0.25);
    }

    .input-group-text {
        border-color: #dee2e6;
    }

    /* Responsive */
    @media (max-width: 576px) {
        .pagination-modern .page-link {
            min-width: 36px;
            height: 36px;
            font-size: 0.875rem;
        }

        /* Ẩn nút First/Last trên mobile */
        .pagination-modern .page-item:first-child,
        .pagination-modern .page-item:last-child {
            display: none;
        }
    }

    .rating i {
        font-size: 0.75rem;
    }

    .card-title {
        color: var(--dark-text);
        transition: color 0.3s ease;
    }

    .card-title:hover {
        color: var(--primary-green);
    }
    /* Giới hạn chiều cao và thêm scroll */
    .category-scroll-container {
        max-height: 400px; /* Tùy chỉnh chiều cao */
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px; /* Tránh che scrollbar */
    }

    /* Custom scrollbar đẹp hơn */
    .category-scroll-container::-webkit-scrollbar {
        width: 6px;
    }

    .category-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .category-scroll-container::-webkit-scrollbar-thumb {
        background: var(--primary-green);
        border-radius: 10px;
    }

    .category-scroll-container::-webkit-scrollbar-thumb:hover {
        background: var(--dark-text);
    }

    /* Smooth scroll */
    .category-scroll-container {
        scroll-behavior: smooth;
    }

    /* Shadow khi scroll */
    .category-scroll-container {
        position: relative;
    }

    .category-scroll-container::before {
        content: '';
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to bottom, rgba(255,255,255,1), rgba(255,255,255,0));
        pointer-events: none;
        z-index: 1;
    }

    .category-scroll-container::after {
        content: '';
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
        pointer-events: none;
    }
</style>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<div th:replace="~{fragments/footer :: footer-bottom}"></div>

<!-- Scripts -->
<th:block th:replace="~{fragments/footer :: scripts}"></th:block>

<!-- Books JavaScript -->
<script th:src="@{/js/books.js}"></script>
<!-- Cart JavaScript -->
<script th:src="@{/js/cart.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof BooksAPI !== 'undefined') {
            BooksAPI.attachEventListeners();
            BooksAPI.attachBookActions();
        }
    });

    function jumpToPage() {
        const pageInput = document.getElementById('jumpToPage');
        const page = parseInt(pageInput.value);
        const totalPages = parseInt(pageInput.max);

        if (page && page >= 1 && page <= totalPages) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('page', page - 1);
            window.location.href = currentUrl.toString();
        } else {
            showToast('Vui lòng nhập số trang hợp lệ (1-' + totalPages + ')', 'warning');
            pageInput.value = '';
        }
    }

    document.getElementById('jumpToPage')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            jumpToPage();
        }
    });
</script>


</body>
</html>